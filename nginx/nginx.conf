# ═══════════════════════════════════════════════════════════════════════════════
# EventSphere Nginx Reverse Proxy Configuration
# ═══════════════════════════════════════════════════════════════════════════════
# 
# Architecture Overview:
# ├─ Client (Port 80) ──HTTP Request──> Nginx Reverse Proxy
# │                                        │
# │                                        ├─ Static Assets ──> /usr/share/nginx/html
# │                                        │   (index.html, CSS, JS - cached 1h)
# │                                        │
# │                                        └─ API Routes ──> Node.js Backend (app:3000)
# │                                           (events, registrations, health - no cache)
# │
# └─────────────────────HTTP Response─────────────────────────────────────────
#
# ═══════════════════════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════════════════════
# UPSTREAM BACKEND DEFINITION
# ═══════════════════════════════════════════════════════════════════════════════
# Defines the Node.js/Express application running inside the container network
# - server app:3000: Internal DNS reference to the 'app' service
# - keepalive 16: Connection pooling for efficient resource usage
upstream eventsphere_app {
  server app:3000;
  keepalive 16;
}

# ═══════════════════════════════════════════════════════════════════════════════
# MAIN SERVER BLOCK: HTTP on Port 80
# ═══════════════════════════════════════════════════════════════════════════════
# This is the ONLY public-facing port. All traffic enters here.
# Nginx decides whether to serve static files or proxy to the Node.js backend.
server {
  listen 80 default_server;
  listen [::]:80 default_server;
  server_name _;

  # ═════════════════════════════════════════════════════════════════════════════
  # GLOBAL SERVER SETTINGS
  # ═════════════════════════════════════════════════════════════════════════════
  client_max_body_size 10M;
  
  # Security headers applied to all responses
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  
  # Logging configuration
  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log warn;

  # ═════════════════════════════════════════════════════════════════════════════
  # LOCATION 1: FRONTEND STATIC FILES
  # ═════════════════════════════════════════════════════════════════════════════
  # Request Path:  http://localhost/
  # Response:      Serves HTML, CSS, JS from /usr/share/nginx/html
  # Cache Policy:  1 hour (browser re-validates with server)
  # Purpose:       Single Page Application routing
  #
  # ROUTING FLOW:
  #   Request: GET /
  #   └─> Nginx checks: /usr/share/nginx/html/
  #   └─> File exists? Serve it
  #   └─> Not found? Serve /index.html (SPA routing)
  #   └─> Browser: index.html loads and handles client-side routing
  location / {
    root /usr/share/nginx/html;
    index index.html index.htm;
    
    # Try files in order: exact file, directory, then fallback to index.html
    # This enables client-side routing (React Router, Vue Router, etc.)
    try_files $uri $uri/ /index.html;
    
    # Cache frontend assets for 1 hour
    # Browser will cache but must revalidate after 1h
    expires 1h;
    add_header Cache-Control "public, max-age=3600, must-revalidate";
    add_header Pragma "cache";
  }

  # ═════════════════════════════════════════════════════════════════════════════
  # LOCATION 2: API ENDPOINTS - PROXY TO NODE.JS BACKEND
  # ═════════════════════════════════════════════════════════════════════════════
  # Request Paths: /events*, /register*, /registrations*, /health
  # Destination:   http://app:3000 (Node.js Express server)
  # Cache Policy:  No caching (API responses are dynamic)
  # Purpose:       Route all API traffic to the backend
  #
  # ROUTING FLOW:
  #   Request: POST /events with JSON body
  #   └─> Nginx receives on port 80
  #   └─> Matches location ~ ^/(events|register|registrations|health)
  #   └─> Proxies to upstream 'eventsphere_app' (app:3000)
  #   └─> Node.js Express handles the request
  #   └─> Response flows back through Nginx to client
  location ~ ^/(events|register|registrations|health) {
    # Proxy settings
    proxy_pass http://eventsphere_app;
    proxy_http_version 1.1;
    
    # Connection pooling: reuse connections to backend
    proxy_set_header Connection "";
    
    # Pass original request information to backend
    # (allows Node.js to see real client IP, not Nginx's IP)
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # CORS Headers
    # Allows cross-origin requests from any client
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;
    
    # Disable caching for API responses
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    
    # Handle CORS preflight requests
    if ($request_method = 'OPTIONS') {
      return 204;
    }
  }

  # ═════════════════════════════════════════════════════════════════════════════
  # LOCATION 3: SECURITY - BLOCK SENSITIVE FILES
  # ═════════════════════════════════════════════════════════════════════════════
  # Prevents exposure of hidden files, git data, and sensitive Node.js files
  location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
  }

  location ~ /(node_modules|\.env|package\.json|seed\.js|Dockerfile) {
    deny all;
    access_log off;
    log_not_found off;
  }

}

